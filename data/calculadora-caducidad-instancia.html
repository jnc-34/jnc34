<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de Caducidad de la Instancia</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;max-width:900px;margin:0 auto}
    body{padding:18px;color:#111}
    h1{font-size:1.4rem;margin-bottom:.2rem}
    label{display:block;margin-top:12px}
    input,select,button{font-size:1rem;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ddd}
    .row{display:flex;gap:10px;align-items:center}
    .result{margin-top:16px;padding:12px;border-radius:8px;background:#f7f7fb;border:1px solid #eee}
    .warning{background:#fff3cd;border:1px solid #ffeeba;padding:12px;border-radius:8px;margin-top:12px;white-space:pre-wrap}
    small{color:#555}
    footer{margin-top:20px;font-size:.85rem;color:#444}
    .muted{color:#666;font-size:.9rem}
  </style>
</head>
<body>
  <h1>Calculadora de Caducidad de la Instancia</h1>

  <div class="warning" id="advertencia"></div>

  <form id="form" onsubmit="return false;">
    <label>1) Seleccione el plazo del art. 310 CPCCN a computar:</label>
    <select id="tipoPlazo">
      <option value="6">6 meses (primera o única instancia), inc. 1°</option>
      <option value="3">3 meses (segunda o tercera instancia, juicio sumarísimo, ejecutivo, ejecuciones especiales e incidentes), inc. 2°</option>
      <option value="custom">De prescripción de la acción (inc. 3°) - indicar meses (máx 6)</option>
      <option value="1">1 mes (incidente de caducidad de instancia), inc. 4°</option>
    </select>

    <div id="customContainer" style="display:none">
      <label>Indique plazo en meses (1-6):</label>
      <input type="number" id="customMonths" min="1" max="6" value="6" />
    </div>

    <label>2) Indique fecha del último acto que impulsó el procedimiento:</label>
    <div class="row">
      <input id="dia" type="text" inputmode="numeric" maxlength="2" placeholder="DD" style="width:72px;" />
      <input id="mes" type="text" inputmode="numeric" maxlength="2" placeholder="MM" style="width:72px;" />
      <input id="anio" type="text" inputmode="numeric" maxlength="4" placeholder="AAAA" style="width:120px;" />
    </div>

    <div style="margin-top:12px">
      <button type="button" id="calcular">Calcular vencimiento</button>
      <button type="button" id="limpiar">Limpiar</button>
    </div>
  </form>

  <div class="result" id="resultado" style="display:none">
    <strong>Vencimiento:</strong>
    <div id="vencimientoText" style="margin-top:8px"></div>
    <small id="explicacion" class="muted"></small>
  </div>

  <footer>
    <p class="muted">Notas: Esta calculadora implementa la lógica solicitada (cómputo fecha a fecha; si el día final no existe en el mes de vencimiento se toma el último día; se excluyen exclusivamente las ferias judiciales: todo enero y 12 días corridos a partir del 3er lunes de julio). Revise siempre con criterio profesional.</p>
  </footer>

<script>
/* ===== ADVERTENCIA (editable) ===== */
const advertenciaTexto = `A continuación se presenta una "Calculadora de Caducidad de la Instancia" cuyo código fuente fue generado mediante Inteligencia Artificial y puede contener errores. Es una herramienta complementaria y no sustituye el criterio profesional ni la consulta de la normativa vigente.

Consideraciones clave para el cómputo:
- Receso de verano: se excluye todo el mes de enero (1 al 31).
- Receso de invierno: se excluyen 12 días corridos a partir del tercer lunes de julio de cada año.
Las fechas del Receso Invernal son variables y definidas anualmente por la CSJN; verifíquelas.

Utilice esta calculadora bajo su propia responsabilidad y contrastando siempre el resultado.`;
document.getElementById('advertencia').innerText = advertenciaTexto;

/* ===== HELPERS DE FECHA EN UTC (más robusto ante DST) ===== */
function utcDate(y,m,d){ return new Date(Date.UTC(y,m,d)); } // m: 0-11
function cloneDate(d){ return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())); }
function daysInMonth(y,m){ return new Date(Date.UTC(y,m+1,0)).getUTCDate(); }
function addDaysUTC(d, n){
  const y=d.getUTCFullYear(), m=d.getUTCMonth(), day=d.getUTCDate();
  const dt = utcDate(y,m,day + n);
  return dt;
}
function formatDate(d){ if(!(d instanceof Date) || isNaN(d)) return 'Invalid'; const dd=('0'+d.getUTCDate()).slice(-2); const mm=('0'+(d.getUTCMonth()+1)).slice(-2); return `${dd}/${mm}/${d.getUTCFullYear()}`; }

/* suma meses fecha-a-fecha en UTC (si no existe día -> último día del mes) */
function addMonthsDateToDateUTC(date, months){
  const y = date.getUTCFullYear(), m = date.getUTCMonth(), day = date.getUTCDate();
  const targetMonthIndex = m + months;
  const targetYear = y + Math.floor(targetMonthIndex / 12);
  const targetMonth = targetMonthIndex % 12;
  const dim = daysInMonth(targetYear, targetMonth);
  const resultDay = Math.min(day, dim);
  return utcDate(targetYear, targetMonth, resultDay);
}

/* tercer lunes de julio (UTC) */
function thirdMondayOfJulyUTC(year){
  const d = utcDate(year,6,1); // julio = 6
  const dow = d.getUTCDay(); // 0 domingo
  const firstMonday = 1 + ((8 - dow) % 7);
  const thirdMonday = firstMonday + 14;
  return utcDate(year,6,thirdMonday);
}

/* construir períodos excluidos: todo enero (1-31) y receso invierno: 12 días desde 3er lunes de julio */
function buildExcludedPeriodsUTC(yearFrom, yearTo){
  const periods = [];
  for(let y = yearFrom - 1; y <= yearTo + 1; y++){
    periods.push({ start: utcDate(y,0,1), end: utcDate(y,0,31) }); // enero
    const tm = thirdMondayOfJulyUTC(y);
    const start = tm;
    const end = addDaysUTC(start, 11); // 12 días inclusivos
    periods.push({ start, end });
  }
  return periods;
}

/* overlapDays inclusive entre [a,b] y [c,d] en días (operando en UTC) */
function overlapDaysInclusiveUTC(a,b,c,d){
  // if a > b or c > d => 0
  if(a.getTime() > b.getTime() || c.getTime() > d.getTime()) return 0;
  const start = a.getTime() > c.getTime() ? a : c;
  const end = b.getTime() < d.getTime() ? b : d;
  if(start.getTime() > end.getTime()) return 0;
  const msPerDay = 24*60*60*1000;
  return Math.floor((end.getTime() - start.getTime()) / msPerDay) + 1;
}

/* comprueba si una fecha UTC cae dentro de algún periodo excluido */
function findContainingPeriodUTC(date, periods){
  for(const p of periods){
    if(date.getTime() >= p.start.getTime() && date.getTime() <= p.end.getTime()) return p;
  }
  return null;
}

/* ===== ALGORITMO ROBUSTO =====
   1) candidate = start + months (fecha a fecha)
   2) totalExcluded = suma de días excluidos en (start, candidate]  -> intervalStart = start + 1 día
   3) candidate += totalExcluded
   4) si candidate queda dentro de una feria -> candidate = día siguiente al final de esa feria
   5) repetir hasta estabilizar (top 50 iter)
*/
function computeExpirationUTC(startDate, months){
  if(!(startDate instanceof Date) || isNaN(startDate)) return null;

  // convertir a UTC midnight (evita problemas de zona)
  let startUTC = utcDate(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate());

  // primer candidato
  let candidate = addMonthsDateToDateUTC(startUTC, months);
  let excluded = buildExcludedPeriodsUTC(startUTC.getUTCFullYear(), candidate.getUTCFullYear() + 1);

  const maxIter = 50;
  let iter = 0;
  while(iter < maxIter){
    iter++;
    // intervalo contado: desde el día siguiente al acto (start+1) hasta candidate inclusive
    const intervalStart = addDaysUTC(startUTC, 1);
    const intervalEnd = candidate;

    // sumar días excluidos dentro del intervalo
    let totalExcluded = 0;
    for(const p of excluded){
      totalExcluded += overlapDaysInclusiveUTC(intervalStart, intervalEnd, p.start, p.end);
    }

    if(totalExcluded > 0){
      candidate = addDaysUTC(candidate, totalExcluded);
      // reconstruir excluded si hemos pasado a años nuevos
      excluded = buildExcludedPeriodsUTC(startUTC.getUTCFullYear(), candidate.getUTCFullYear() + 1);
      // iterar de nuevo
      continue;
    }

    // si candidate cae dentro de una feria -> mover al día siguiente al final de la feria y recomputar
    const inside = findContainingPeriodUTC(candidate, excluded);
    if(inside){
      candidate = addDaysUTC(inside.end, 1);
      excluded = buildExcludedPeriodsUTC(startUTC.getUTCFullYear(), candidate.getUTCFullYear() + 1);
      continue;
    }

    // si no hubo cambios -> terminado
    break;
  }

  // si maxIter alcanzado, devolvemos candidate (caso improbable)
  return candidate;
}

/* ===== UI wiring ===== */
const tipoPlazo = document.getElementById('tipoPlazo');
const customContainer = document.getElementById('customContainer');
const customMonths = document.getElementById('customMonths');
const diaInput = document.getElementById('dia');
const mesInput = document.getElementById('mes');
const anioInput = document.getElementById('anio');
const resultadoDiv = document.getElementById('resultado');
const vencimientoText = document.getElementById('vencimientoText');
const explicacion = document.getElementById('explicacion');

tipoPlazo.addEventListener('change', ()=>{ customContainer.style.display = (tipoPlazo.value === 'custom') ? 'block' : 'none'; });

// permitir sólo dígitos
function onlyDigits(e){ const allowed = ['Backspace','ArrowLeft','ArrowRight','Tab','Delete']; if(allowed.includes(e.key)) return; if(!/^[0-9]$/.test(e.key)) e.preventDefault(); }
[diaInput, mesInput, anioInput].forEach(i => i.addEventListener('keydown', onlyDigits));

function parseUserDate(){
  const d = diaInput.value.trim(), m = mesInput.value.trim(), y = anioInput.value.trim();
  if(!/^\d{1,2}$/.test(d) || !/^\d{1,2}$/.test(m) || !/^\d{4}$/.test(y)) return null;
  const day = parseInt(d,10), month = parseInt(m,10), year = parseInt(y,10);
  if(month < 1 || month > 12) return null;
  const dim = daysInMonth(year, month - 1);
  if(day < 1 || day > dim) return null;
  // devolver Date en UTC midnight para consistencia
  return utcDate(year, month - 1, day);
}

function showError(msg){ alert(msg); }

document.getElementById('calcular').addEventListener('click', ()=>{
  const start = parseUserDate();
  if(!start){ showError('Indique una fecha válida en formato DD MM AAAA'); return; }

  let months = 0;
  if(tipoPlazo.value === 'custom'){
    months = parseInt(customMonths.value, 10);
    if(isNaN(months) || months < 1 || months > 6){ showError('El plazo de prescripción (inc.3°) debe estar entre 1 y 6 meses'); return; }
  } else months = parseInt(tipoPlazo.value, 10);

  const venc = computeExpirationUTC(start, months);
  if(!venc){ showError('Error al calcular la fecha. Revise la entrada.'); return; }

  resultadoDiv.style.display = 'block';
  vencimientoText.innerText = formatDate(venc) + ' — vence a las 24:00 hrs del día indicado';
  explicacion.innerText = `Cómputo iniciado el ${formatDate(start)}. Plazo nominal: ${months} mes(es). Se aplicaron exclusiones de ferias (enero y receso de invierno).`;
});

document.getElementById('limpiar').addEventListener('click', ()=>{
  diaInput.value = ''; mesInput.value = ''; anioInput.value = ''; tipoPlazo.value = '6'; customContainer.style.display = 'none'; customMonths.value = '6'; resultadoDiv.style.display = 'none';
});

</script>
</body>
</html>
