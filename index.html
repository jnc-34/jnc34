<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de Plazos - Fuero Nacional Civil</title>
  <style>
    /* Palette y estilos más amigables */
    :root{
      --bg: #f6f9fc;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #0f172a;
      --accent: #0b76f4; /* azul principal */
      --accent-2: #0ea5a4; /* azul-verde secundario */
      --border: #e6eef9;
      --success: #16a34a;
      --warn: #f59e0b;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 18px;
      color: var(--text);
      background: linear-gradient(180deg,#f8fbfc 0%, #f6f9fc 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:980px;margin:0 auto}
    h1{font-size:1.4rem;margin-bottom:6px}
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 14px;
      box-shadow: 0 6px 20px rgba(11,118,244,0.04);
    }
    label{display:block;margin:8px 0 6px;font-weight:700}
    input,select,button{
      padding:10px;border-radius:8px;border:1px solid #e9f1ff;font-size:1rem;background:#fff;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:0.95rem}
    .result{background:linear-gradient(180deg,#ffffff 0%, #f7fbff 100%);padding:14px;border-radius:10px;margin-top:12px;border:1px solid var(--border)}
    ul.trace{background:var(--card);padding:12px;border-radius:8px;border:1px solid var(--border);list-style:none}
    ul.trace li{padding:8px 0;border-bottom:1px dashed #f1f5f9}
    .warn{background:#fff8f0;padding:10px;border-radius:8px;border:1px solid #ffe8cc}
    .muted.small{font-size:0.88rem}
    button{
      cursor:pointer;border:none;background:var(--accent);color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;
      box-shadow: 0 6px 16px rgba(11,118,244,0.12);
    }
    button.secondary{background:transparent;color:var(--accent);border:1px solid rgba(11,118,244,0.12);box-shadow:none}
    .meta{font-size:0.9rem;color:var(--muted)}
    .flex{display:flex;gap:12px;align-items:center}
    @media(max-width:720px){ .row{flex-direction:column} .flex{flex-direction:column;align-items:flex-start} }
    a{color:var(--accent-2);text-decoration:underline}
    .small-bubble{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(14,165,164,0.08);color:var(--accent-2);font-weight:700;font-size:0.85rem}
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculadora de plazos (Fuero Nacional Civil)</h1>

    <div class="card">
      <label>Modalidad de notificación</label>
      <select id="modalidad" aria-label="Modalidad de notificación">
        <option value="cedula_habil">1. Por cédula - día y hora hábil según art. 152, 3er párrafo CPCCN</option>
        <option value="cedula_inhabil">2. Por cédula - día y hora hábil (por fuera de los supuestos del art. 152 CPCCN)</option>
        <option value="nota">3. Por nota - notificación automática (art. 133 CPCCN)</option>
      </select>

      <label id="fechaLabel">Indicar fecha</label>
      <div class="row" style="margin-bottom:8px;">
        <input id="dia" placeholder="DD" maxlength="2" style="width:86px" />
        <input id="mes" placeholder="MM" maxlength="2" style="width:86px" />
        <input id="anio" placeholder="AAAA" maxlength="4" style="width:118px" />
      </div>

      <div class="flex">
        <div style="flex:0 0 220px">
          <label>Indicar duración del plazo</label>
          <input id="duracion" type="number" min="1" value="5" style="width:120px" />
        </div>

        <div style="flex:1">
          <label style="visibility:hidden">Acciones</label>
          <div>
            <button id="calcular">Calcular vencimiento</button>
            <button id="reset" class="secondary" style="margin-left:8px">Limpiar</button>
          </div>
        </div>
      </div>

      <p class="meta" style="margin-top:10px">Años soportados: <span id="anioRange" class="small-bubble"></span></p>
    </div>

    <div id="output" class="card" style="display:none">
      <h2>Resultado</h2>
      <div id="vencimiento" class="result"></div>
      <div id="notaGracia" class="warn" style="margin-top:8px;display:none"></div>

      <h3 style="margin-top:14px">Trazabilidad</h3>
      <p><strong>Fecha de inicio del conteo:</strong> <span id="inicioConteo"></span></p>
      <p><strong>Días NO contados (inhábiles) dentro del periodo de cálculo:</strong></p>
      <ul id="listaInhabiles" class="trace"></ul>

      <p class="muted" style="margin-top:10px">Si crees que hubo un error, por favor escribe a <a href="mailto:jncivil34@pjn.gov.ar">jncivil34@pjn.gov.ar</a> indicando el problema y, si puedes, adjunta una captura.</p>
    </div>
  </div>

  <script>
  // -----------------------------
  // CONFIG
  // -----------------------------
  const API_BASE = 'https://api.argentinadatos.com/v1/feriados';
  const MIN_YEAR = 2021;
  let MAX_YEAR = new Date().getFullYear();
  if (MAX_YEAR < 2025) MAX_YEAR = 2025;

  // -----------------------------
  // UTIL
  // -----------------------------
  function toYmd(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function parseYmd(str){ const [y,m,day]=str.split('-').map(Number); return new Date(y,m-1,day); }
  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  // -----------------------------
  // CÁLCULO: tercer lunes de julio y 14 días subsiguientes
  // -----------------------------
  function thirdMondayOfJuly(year){ const d=new Date(year,6,1); while(d.getDay()!==1) d.setDate(d.getDate()+1); return addDays(d,14); }

  function customInhabilesForYear(year){
  const res = new Map();
  // todos los días de enero
  for(let day=1; day<=31; day++){
    const d = new Date(year, 0, day);
    res.set(toYmd(d), 'Feria de enero');
  }

  // 16 de noviembre
  const nov16 = new Date(year, 10, 16);
  res.set(toYmd(nov16), '16 de noviembre (ley local)');

  // Feria de julio: 14 días corridos *incluyendo* el 3er lunes de julio
  const thirdMon = thirdMondayOfJuly(year); // devuelve la fecha del 3er lunes
  // Añadimos desde thirdMon + 0 hasta thirdMon + 13 (14 días en total)
  for(let i = 0; i < 14; i++){
    const d = addDays(thirdMon, i);
    res.set(toYmd(d), 'Feria de julio');
  }

  return res;
}

  // ---------- Robust fetch for custom overrides ----------
  async function tryFetch(url){
    try{
      const res = await fetch(url, {cache: 'no-store'});
      if(res.ok){
        const j = await res.json();
        console.log('custom_inhabiles.json cargado desde', url);
        return {ok: true, data: j};
      } else {
        console.warn('intentó y falló:', url, res.status);
        return {ok:false, status: res.status};
      }
    }catch(e){
      console.warn('error fetch url', url, e);
      return {ok:false, error: e};
    }
  }

  async function fetchCustomOverrides(){
    // construimos lista de URLs a intentar (con cache buster)
    const cb = '_=' + Date.now();
    const candidates = [];

    // relativa respecto al documento actual
    candidates.push('./data/custom_inhabiles.json?' + cb);
    candidates.push('data/custom_inhabiles.json?' + cb);
    // raíz del dominio (fallará en project pages)
    candidates.push('/data/custom_inhabiles.json?' + cb);

    // fallback: intentar deducir raw.githubusercontent (útil si GitHub Pages sirve en /<repo>/)
    try {
      const host = location.hostname; // e.g. usuario.github.io or custom domain
      const pathParts = location.pathname.split('/').filter(Boolean); // ['<repo>', ...] for project pages
      if(host.endsWith('github.io') && pathParts.length >= 1){
        const user = host.split('.')[0]; // usuario
        const repo = pathParts[0]; // repo name as first path segment
        const rawUrl = `https://raw.githubusercontent.com/${user}/${repo}/main/data/custom_inhabiles.json?${cb}`;
        candidates.push(rawUrl);
      }
    } catch(e){ /* ignore */ }

    for(const url of candidates){
      const r = await tryFetch(url);
      if(r.ok && r.data){
        return Array.isArray(r.data.overrides) ? r.data.overrides : [];
      }
    }
    console.warn('No se pudo cargar custom_inhabiles.json desde las rutas intentadas:', candidates);
    return [];
  }

  async function buildInhabilesForYears(years){
    const combined = new Map();
    for(const y of years){
      const api = await fetchFeriados(y);
      for(const [k,v] of api.entries()) combined.set(k, 'Feriado: '+v);
      const custom = customInhabilesForYear(y);
      for(const [k,v] of custom.entries()) combined.set(k, v);
    }

    // overrides globales (archivo JSON)
    const overrides = await fetchCustomOverrides();
    overrides.forEach(o => {
      if(o && o.fecha && o.motivo){
        combined.set(o.fecha, `${o.motivo} (override)`);
      }
    });

    return combined;
  }

  function isWeekend(date){ const d = date.getDay(); return d===0||d===6; }
  function isInMapYmd(map,date){ return map.has(toYmd(date)); }
  function isBusinessDay(date, inhMap){ return !isWeekend(date) && !isInMapYmd(inhMap,date); }

  function nextBusinessDay(date, inhMap){ let d = new Date(date); d.setHours(0,0,0,0); while(!isBusinessDay(d,inhMap)) d = addDays(d,1); return d; }
  function nextBusinessDayStrict(date, inhMap){ return nextBusinessDay(addDays(date,1), inhMap); }

  function computeStartDate(modalidad,inputDate,inhMap){
    const notifDate = new Date(inputDate); notifDate.setHours(0,0,0,0);
    if(modalidad==='cedula_habil'){
      return nextBusinessDayStrict(notifDate, inhMap);
    }
    if(modalidad==='cedula_inhabil'){
      const first = nextBusinessDayStrict(notifDate, inhMap);
      return nextBusinessDayStrict(first, inhMap);
    }
    if(modalidad==='nota'){
      // CORRECCIÓN: la notificación se considera efectuada el día martes o viernes hábil siguiente a la fecha indicada
      let d = addDays(notifDate,1);
      while(true){
        // ahora buscamos martes (2) o viernes (5)
        if(isBusinessDay(d,inhMap) && (d.getDay()===2 || d.getDay()===5)) break;
        d = addDays(d,1);
      }
      // 'd' es el día de nota; el inicio del conteo es el día hábil siguiente a 'd'
      const start = nextBusinessDayStrict(d, inhMap);
      return start;
    }
    throw new Error('Modalidad desconocida');
  }

  function countPeriod(startDate, days, inhMap){
    let counted=0; let cursor = new Date(startDate); cursor.setHours(0,0,0,0);
    while(counted < days){
      if(isBusinessDay(cursor, inhMap)){
        counted++;
      }
      if(counted>=days) break;
      cursor = addDays(cursor,1);
    }
    return {lastCountedDay: cursor};
  }

  function computeVencimiento(lastCountedDay, inhMap){
    const nextBiz = nextBusinessDayStrict(lastCountedDay, inhMap);
    const expiration = new Date(nextBiz); expiration.setHours(9,30,0,0);
    let prev = addDays(nextBiz,-1); while(!isBusinessDay(prev,inhMap)) prev = addDays(prev,-1);
    return {expiration, altNoGracia: prev};
  }

  function gatherInhabilesBetween(startDate, endDate, inhMap){
    const res = [];
    let cur = new Date(startDate); cur.setHours(0,0,0,0);
    const end = new Date(endDate); end.setHours(0,0,0,0);
    while(cur <= end){
      if(!isBusinessDay(cur, inhMap)){
        const motivo = isWeekend(cur)? 'Fin de semana' : (inhMap.get(toYmd(cur)) || 'Inhábil');
        res.push({fecha: toYmd(cur), motivo});
      }
      cur = addDays(cur,1);
    }
    return res;
  }

  // -----------------------------
  // UI wiring
  // -----------------------------
  document.getElementById('anioRange').textContent = `${MIN_YEAR} - ${MAX_YEAR}`;
  const modalidadSel = document.getElementById('modalidad');
  modalidadSel.addEventListener('change', ()=>{
    const label = document.getElementById('fechaLabel');
    label.textContent = (modalidadSel.value==='nota')? 'Indicar fecha (firma de la resolución)' : 'Indicar fecha';
  });

  document.getElementById('reset').addEventListener('click',()=>{ document.getElementById('dia').value='';document.getElementById('mes').value='';document.getElementById('anio').value='';document.getElementById('duracion').value='5'; document.getElementById('output').style.display='none'; });

  document.getElementById('calcular').addEventListener('click', async ()=>{
    const diaRaw = document.getElementById('dia').value;
    const mesRaw = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    if(!diaRaw || !mesRaw || !anio) return alert('Por favor indique día, mes y año.');
    const dia = String(diaRaw).padStart(2,'0'); const mes = String(mesRaw).padStart(2,'0');
    const inputDate = new Date(Number(anio), Number(mes)-1, Number(dia));

    const yearsToFetch = [];
    const y0 = inputDate.getFullYear();
    for(let yy=Math.max(MIN_YEAR, y0-1); yy<=Math.max(y0+1, MAX_YEAR+1); yy++) yearsToFetch.push(yy);

    const inhMap = await buildInhabilesForYears(Array.from(new Set(yearsToFetch)).sort());

    const modalidad = modalidadSel.value;
    const start = computeStartDate(modalidad, inputDate, inhMap);

    document.getElementById('inicioConteo').textContent = start.toLocaleDateString('es-AR');

    const days = Number(document.getElementById('duracion').value);
    const {lastCountedDay} = countPeriod(start, days, inhMap);

    const {expiration, altNoGracia} = computeVencimiento(lastCountedDay, inhMap);

    const ignored = gatherInhabilesBetween(inputDate, lastCountedDay, inhMap);

    document.getElementById('vencimiento').innerHTML = `Vencimiento del plazo: <strong>${expiration.toLocaleString('es-AR', {year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}</strong>.`;
    document.getElementById('notaGracia').style.display='block';
    document.getElementById('notaGracia').innerHTML = `Nota: si <strong>NO</strong> resulta aplicable el plazo de gracia del art. 124 CPCCN, el vencimiento se produce el día: <strong>${altNoGracia.toLocaleDateString('es-AR')}</strong>.`;

    const ul = document.getElementById('listaInhabiles'); ul.innerHTML='';
    if(ignored.length===0){ const li=document.createElement('li'); li.textContent='No se detectaron días inhábiles dentro del periodo.'; ul.appendChild(li); }
    ignored.forEach(it=>{ const li=document.createElement('li'); const d = parseYmd(it.fecha); li.textContent = `${d.toLocaleDateString('es-AR')} — ${it.motivo}`; ul.appendChild(li); });

    document.getElementById('output').style.display='block';
  });
  </script>
</body>
</html>
