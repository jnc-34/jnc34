<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de Plazos - Fuero Nacional Civil</title>
  <style>
    :root{
      --bg: #ffffff;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #0f172a;
      --border: #eef2f7;
    }
    /* Layout */
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin:18px;
      color:var(--accent);
      background: var(--bg); /* TODO: entirely white theme */
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:960px;margin:0 auto}
    h1{font-size:1.35rem;margin-bottom:8px}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      padding:18px;
      border-radius:10px;
      margin-bottom:14px;
      box-shadow: 0 4px 10px rgba(15,23,42,0.03);
    }
    label{display:block;margin:8px 0 6px;font-weight:700}
    input,select,button{
      padding:10px;border-radius:8px;border:1px solid var(--border);font-size:1rem;
      background: #fff;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:0.95rem}
    .result{background:var(--card);padding:14px;border-radius:10px;margin-top:12px;border:1px solid var(--border)}
    ul.trace{background:var(--card);padding:12px;border-radius:8px;border:1px solid var(--border);list-style:none}
    ul.trace li{padding:6px 0;border-bottom:1px dashed #f5f7fa}
    .warn{background:#fff8f0;padding:10px;border-radius:8px;border:1px solid #ffe8cc}
    .muted.small{font-size:0.88rem}
    button{cursor:pointer}
    @media(max-width:680px){ .row{flex-direction:column} }
    a { color: inherit; text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculadora de plazos (Fuero Nacional Civil)</h1>

    <div class="card">
      <label>Modalidad de notificación</label>
      <select id="modalidad">
        <option value="cedula_habil">1. Por cédula - día y hora hábil según art. 152, 3er párrafo CPCCN</option>
        <option value="cedula_inhabil">2. Por cédula - día y hora hábil (por fuera de los supuestos del art. 152 CPCCN)</option>
        <option value="nota">3. Por nota - notificación automática (art. 133 CPCCN)</option>
      </select>

      <label id="fechaLabel">Indicar fecha</label>
      <div class="row" style="margin-bottom:8px;">
        <input id="dia" placeholder="DD" maxlength="2" style="width:86px" />
        <input id="mes" placeholder="MM" maxlength="2" style="width:86px" />
        <input id="anio" placeholder="AAAA" maxlength="4" style="width:118px" />
      </div>

      <label>Indicar duración del plazo</label>
      <input id="duracion" type="number" min="1" value="5" style="width:120px" />

      <div style="margin-top:12px">
        <button id="calcular">Calcular vencimiento</button>
        <button id="reset" style="margin-left:8px">Limpiar</button>
      </div>

      <p class="muted small" style="margin-top:10px">Años soportados: <span id="anioRange"></span></p>
    </div>

    <div id="output" class="card" style="display:none">
      <h2>Resultado</h2>
      <div id="vencimiento" class="result"></div>
      <div id="notaGracia" class="warn" style="margin-top:8px;display:none"></div>

      <h3 style="margin-top:14px">Trazabilidad</h3>
      <p><strong>Fecha de inicio del conteo:</strong> <span id="inicioConteo"></span></p>
      <p><strong>Días NO contados (inhábiles) dentro del periodo de cálculo:</strong></p>
      <ul id="listaInhabiles" class="trace"></ul>

      <p class="muted" style="margin-top:10px">Si crees que hubo un error, por favor escribe a <a href="mailto:jncivil34@pjn.gov.ar">jncivil34@pjn.gov.ar</a> indicando el problema y, si puedes, adjunta una captura.</p>
    </div>
  </div>

  <script>
  // -----------------------------
  // CONFIG
  // -----------------------------
  const API_BASE = 'https://api.argentinadatos.com/v1/feriados';
  const MIN_YEAR = 2021;
  let MAX_YEAR = new Date().getFullYear();
  if (MAX_YEAR < 2025) MAX_YEAR = 2025;

  // -----------------------------
  // UTIL
  // -----------------------------
  function toYmd(d){
    // formatea en base a componentes locales (evita problemas de zona horaria)
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function parseYmd(str){ const [y,m,day]=str.split('-').map(Number); return new Date(y,m-1,day); }
  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

  // -----------------------------
  // CÁLCULO: tercer lunes de julio y 14 días subsiguientes
  // -----------------------------
  function thirdMondayOfJuly(year){ const d=new Date(year,6,1); while(d.getDay()!==1) d.setDate(d.getDate()+1); return addDays(d,14); }

  function customInhabilesForYear(year){
    const res = new Map();
    // all January days
    for(let day=1;day<=31;day++){ const d=new Date(year,0,day); res.set(toYmd(d),'Feria de enero'); }
    // every Nov 16
    const nov16 = new Date(year,10,16); res.set(toYmd(nov16),'16 de noviembre (ley local)');
    // Feria de julio: 14 días corridos subsiguientes al 3er lunes de julio
    const thirdMon = thirdMondayOfJuly(year);
    for(let i=1;i<=14;i++){ res.set(toYmd(addDays(thirdMon,i)),'Feria de julio'); }
    return res;
  }

  async function fetchFeriados(year){
    try{
      const res = await fetch(`${API_BASE}/${year}`);
      if(!res.ok) throw new Error('API feriados no disponible: '+res.status);
      const data = await res.json();
      const m = new Map();
      data.forEach(f=>{ if(f.fecha) m.set(f.fecha, f.nombre || f.tipo || 'Feriado'); });
      return m;
    }catch(e){ console.warn('No se pudieron obtener feriados desde API para',year,e); return new Map(); }
  }

  // Fetch overrides JSON (custom_inhabiles.json)
  async function fetchCustomOverrides(){
    try{
      const res = await fetch('/data/custom_inhabiles.json', {cache: "no-store"});
      if(!res.ok) {
        // si no existe, devolvemos vacío pero no interrumpimos
        console.warn('No se encontró /data/custom_inhabiles.json');
        return [];
      }
      const j = await res.json();
      return Array.isArray(j.overrides) ? j.overrides : [];
    }catch(e){ console.warn('No se pudo cargar custom_inhabiles.json', e); return []; }
  }

  async function buildInhabilesForYears(years){
    const combined = new Map();
    for(const y of years){
      const api = await fetchFeriados(y);
      for(const [k,v] of api.entries()) combined.set(k, 'Feriado: '+v);
      const custom = customInhabilesForYear(y);
      for(const [k,v] of custom.entries()) combined.set(k, v);
    }

    // incorporar overrides globales (archivo JSON)
    const overrides = await fetchCustomOverrides();
    overrides.forEach(o => {
      if(o.fecha && o.motivo){
        // normalizar fecha (se espera YYYY-MM-DD)
        combined.set(o.fecha, o.motivo + ' (override)');
      }
    });

    return combined;
  }

  function isWeekend(date){ const d = date.getDay(); return d===0||d===6; }
  function isInMapYmd(map,date){ return map.has(toYmd(date)); }
  function isBusinessDay(date, inhMap){ return !isWeekend(date) && !isInMapYmd(inhMap,date); }

  function nextBusinessDay(date, inhMap){ let d = new Date(date); d.setHours(0,0,0,0); while(!isBusinessDay(d,inhMap)) d = addDays(d,1); return d; }
  function nextBusinessDayStrict(date, inhMap){ return nextBusinessDay(addDays(date,1), inhMap); }

  function computeStartDate(modalidad,inputDate,inhMap){
    const notifDate = new Date(inputDate); notifDate.setHours(0,0,0,0);
    if(modalidad==='cedula_habil'){
      return nextBusinessDayStrict(notifDate, inhMap);
    }
    if(modalidad==='cedula_inhabil'){
      const first = nextBusinessDayStrict(notifDate, inhMap);
      return nextBusinessDayStrict(first, inhMap);
    }
    if(modalidad==='nota'){
      let d = addDays(notifDate,1);
      while(true){ if(isBusinessDay(d,inhMap) && (d.getDay()===2 || d.getDay()===4)) break; d = addDays(d,1); }
      return nextBusinessDayStrict(d, inhMap);
    }
    throw new Error('Modalidad desconocida');
  }

  function countPeriod(startDate, days, inhMap){
    // counts business days starting from startDate inclusive
    let counted=0; let cursor = new Date(startDate); cursor.setHours(0,0,0,0);
    while(counted < days){
      if(isBusinessDay(cursor, inhMap)){
        counted++;
      }
      if(counted>=days) break;
      cursor = addDays(cursor,1);
    }
    return {lastCountedDay: cursor};
  }

  function computeVencimiento(lastCountedDay, inhMap){
    const nextBiz = nextBusinessDayStrict(lastCountedDay, inhMap);
    const expiration = new Date(nextBiz); expiration.setHours(9,30,0,0);
    let prev = addDays(nextBiz,-1); while(!isBusinessDay(prev,inhMap)) prev = addDays(prev,-1);
    return {expiration, altNoGracia: prev};
  }

  // gather inhábiles between two dates inclusive
  function gatherInhabilesBetween(startDate, endDate, inhMap){
    const res = [];
    let cur = new Date(startDate); cur.setHours(0,0,0,0);
    const end = new Date(endDate); end.setHours(0,0,0,0);
    while(cur <= end){
      if(!isBusinessDay(cur, inhMap)){
        const motivo = isWeekend(cur)? 'Fin de semana' : (inhMap.get(toYmd(cur)) || 'Inhábil');
        res.push({fecha: toYmd(cur), motivo});
      }
      cur = addDays(cur,1);
    }
    return res;
  }

  // -----------------------------
  // UI wiring
  // -----------------------------
  document.getElementById('anioRange').textContent = `${MIN_YEAR} - ${MAX_YEAR}`;
  const modalidadSel = document.getElementById('modalidad');
  modalidadSel.addEventListener('change', ()=>{
    const label = document.getElementById('fechaLabel');
    label.textContent = (modalidadSel.value==='nota')? 'Indicar fecha (firma de la resolución)' : 'Indicar fecha';
  });

  document.getElementById('reset').addEventListener('click',()=>{ document.getElementById('dia').value='';document.getElementById('mes').value='';document.getElementById('anio').value='';document.getElementById('duracion').value='5'; document.getElementById('output').style.display='none'; });

  document.getElementById('calcular').addEventListener('click', async ()=>{
    const diaRaw = document.getElementById('dia').value;
    const mesRaw = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    if(!diaRaw || !mesRaw || !anio) return alert('Por favor indique día, mes y año.');
    const dia = String(diaRaw).padStart(2,'0'); const mes = String(mesRaw).padStart(2,'0');
    const inputDate = new Date(Number(anio), Number(mes)-1, Number(dia));

    // build inhábiles for relevant years (range around input)
    const yearsToFetch = [];
    const y0 = inputDate.getFullYear();
    for(let yy=Math.max(MIN_YEAR, y0-1); yy<=Math.max(y0+1, MAX_YEAR+1); yy++) yearsToFetch.push(yy);

    const inhMap = await buildInhabilesForYears(Array.from(new Set(yearsToFetch)).sort());

    // compute start date
    const modalidad = modalidadSel.value;
    const start = computeStartDate(modalidad, inputDate, inhMap);

    // show start
    document.getElementById('inicioConteo').textContent = start.toLocaleDateString('es-AR');

    // count
    const days = Number(document.getElementById('duracion').value);
    const {lastCountedDay} = countPeriod(start, days, inhMap);

    // compute vencimiento
    const {expiration, altNoGracia} = computeVencimiento(lastCountedDay, inhMap);

    // gather inhábiles between NOTIFICATION DATE and lastCountedDay inclusive for traceability
    const ignored = gatherInhabilesBetween(inputDate, lastCountedDay, inhMap);

    // populate output
    document.getElementById('vencimiento').innerHTML = `Vencimiento del plazo: <strong>${expiration.toLocaleString('es-AR', {year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'})}</strong>.`;
    document.getElementById('notaGracia').style.display='block';
    document.getElementById('notaGracia').innerHTML = `Nota: si <strong>NO</strong> resulta aplicable el plazo de gracia del art. 124 CPCCN, el vencimiento se produce el día: <strong>${altNoGracia.toLocaleDateString('es-AR')}</strong>.`;

    const ul = document.getElementById('listaInhabiles'); ul.innerHTML='';
    if(ignored.length===0){ const li=document.createElement('li'); li.textContent='No se detectaron días inhábiles dentro del periodo.'; ul.appendChild(li); }
    ignored.forEach(it=>{ const li=document.createElement('li'); const d = parseYmd(it.fecha); li.textContent = `${d.toLocaleDateString('es-AR')} — ${it.motivo}`; ul.appendChild(li); });

    document.getElementById('output').style.display='block';
  });
  </script>
</body>
</html>
